---
title: "main"
author: "Michael Dowd"
date: "12/4/2019"
output: html_document
---

```{r setup, include=FALSE, results='hide'}
knitr::opts_chunk$set(echo = FALSE)
library('tidyverse')
library('lubridate')
library('reshape2')
library('corrplot')
```

```{r Functions, include=FALSE, results='hide'}

# --------------------------------------------------------
# Reading Functions---------------------------------------

master_dataframe <- function(Directory,MergeColumn) {
  path <- paste("./", Directory, "/", sep = "")
  files <- list.files(path = path)
  dataframes = vector("list", length(files))
  print(length(dataframes))
  i <- 1
  for (i in 1 : length(files)){
    file <- files[i]
    df <- read_csv(paste(path, file, sep = ""))
    colnames <- names(df)
    for (j in 1 : length(colnames)) {
      colname <- colnames[j]
      if (colname != 'Date') {
        prefix <- str_replace(file, '.csv', '_')
        colnames[j] <- paste(prefix, colname, sep = '')
      }
    }
    names(df) <- colnames
    if (i == 1) {
      master <- df
    }
    else {
      master <- merge(master, df, by="Date")
    }
  }  
  return(master)
}

# --------------------------------------------------------
# Feature Engineering Functions---------------------------

offset_dataframe <- function(Data, Offset) {
  if (Offset<0) {
    Data <- Data %>%
    mutate_at(vars(-Date), ~ . - lag(., -Offset)) %>%
    drop_na()
    diffstr <- paste('N', toString(-Offset))
  }
  else if (Offset>0) {
    Data <- Data %>%
    mutate_at(vars(-Date), ~ . - lead(., Offset)) %>%
    drop_na()
    diffstr <- paste('P', toString(Offset))
  }
  
  colnames <- names(Data)
  for (j in 1 : length(colnames)) {
    colname <- colnames[j]
    if (colname != 'Date') {
      colnames[j] <- paste(colname, 'diff', diffstr, sep = '_')
    }
  }
  names(Data) <- colnames
  return(Data)
}

multi_offset <- function(Data, Offsets) {
  for (i in 1:length(Offsets)) {
    offset <- Offsets[i]
    df <- offset_dataframe(Data,offset)
    if (i == 1) {
      master <- df
    }
    else {
      master <- merge(master, df, by="Date")
    }
  }
  return(master)
}

standardise_all_columns <- function(Data) {
  Data %>%
    mutate_at(vars(-Date), ~scale(.)) %>%
    return()
}

dates_dataframe <- function(Data) {
  Data %>%
    select(Date) %>%
    mutate(Part_Of_Year = yday(Date)/365) %>%
    mutate(Part_Of_Month = day(Date)/31) %>%
    mutate(Part_Of_Week = case_when(weekdays(Date) == 'Monday' ~ 0,
                           weekdays(Date) == 'Tuesday' ~ 0.25,
                           weekdays(Date) == 'Wednesday' ~ 0.5,
                           weekdays(Date) == 'Thursday' ~ 0.75,
                           weekdays(Date) == 'Friday' ~ 1.0, TRUE ~ 0.0)) %>%
  return()
}

# --------------------------------------------------------
# Charting Functions--------------------------------------

make_histograms <- function(Data) {
  nrows <- as.integer(ncol(Data) / 5)
  Data %>%
    melt(id.vars='Date',variable.name='series') %>%
    ggplot() +
    aes(x = value, Fill='Red', opacity = 0.7) + 
    geom_density() +
    facet_wrap(. ~ series, nrow = 4)
}

```

#### Input Variables before standardisation
```{r Data Loading and cleaning}
data <- master_dataframe("Data")
dates <- dates_dataframe(data)
diff <- offset_dataframe(data, -1)
target <- offset_dataframe(data, 1)
make_histograms(diff)
```

#### Standardised variables
```{r Standardise columns}
diff <- standardise_all_columns(diff)
target <- standardise_all_columns(target)
make_histograms(diff)
```

#### Biggest Statistically significant Correlations
```{r Correlation plot, fig.width=12, fig.height=12}
merged <- dates %>%
  merge(diff, by = "Date") %>%
  merge(target, by = "Date") %>%
  select(-Date) %>%
  discard(~all(is.na(.x)))

corr_mat <- cor(merged)
p_mat <- cor.mtest(merged, conf.level = 0.99)

corr_df <- data.frame(corr = double(), pval = double(), i_ind = integer(), j_ind = integer())
for (i in 1 : (ncol(dates) + ncol(diff)-3)) {
  for (j in (ncol(dates) + ncol(diff) - 2) : (ncol(merged))) {
    corr <- corr_mat[i, j]
    pval <- p_mat$p[i, j]
    i_ind <- i
    j_ind <- j
    corr_df <- rbind(corr_df, data.frame(corr, pval, i_ind, j_ind))
  }
}

x <- corr_df %>%
  filter(pval<0.01) %>%
  group_by(i_ind) %>%
  summarise(corr = max(corr)) %>%
  arrange(desc(corr)) %>%
  top_n(15) %>%
  distinct(i_ind) %>%
  pull(i_ind)
y <- corr_df %>%
  filter(pval<0.01) %>%
  group_by(j_ind) %>%
  summarise(corr = max(corr)) %>%
  arrange(desc(corr)) %>%
  top_n(15) %>%
  distinct(j_ind) %>%
  pull(j_ind)

corrplot(corr_mat[x, y], tl.cex = 1)
```